<?php

/**
 * @file
 * Entry point for makerspace_user_links module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\user\UserInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Url;

/**
 * Implements hook_theme().
 */
function makerspace_user_links_theme(): array {
  return [
    'makerspace_user_links_list' => [
      'variables' => [
        'link_groups' => [],
      ],
      'template' => 'makerspace-user-links-list',
    ],
  ];
}

/**
 * Implements hook_makerspace_user_links_links().
 */
function makerspace_user_links_makerspace_user_links_links(UserInterface $account, AccountInterface $viewer, string $audience): array {
  $links = [];
  $route_parameters = ['user' => $account->id()];

  // 1. Member Audience (Self-service).
  if ($audience === 'member') {
    if ($account->id() === $viewer->id()) {
      $links[] = [
        'id' => 'edit_profile',
        'title' => t('Edit My Profile'),
        'route_name' => 'entity.user.edit_form',
        'route_parameters' => $route_parameters,
        'category' => t('Quick Links'),
        'weight' => -100,
      ];

      if (\Drupal::moduleHandler()->moduleExists('makerspace_material_store')) {
        $links[] = [
          'id' => 'my_tab',
          'title' => t('My Tab'),
          'route_name' => 'makerspace_material_store.tab',
          'category' => t('Quick Links'),
          'weight' => -90,
          'description' => t('View your unpaid items.'),
        ];
      }
    }
    return $links;
  }

  // 2. Facilitator Audience (Actions on others).
  if ($audience === 'facilitator') {
    if ($viewer->hasPermission('create badge_request content')) {
      $links[] = [
        'id' => 'add_badge',
        'title' => t('Add Badge'),
        'route_name' => 'node.add',
        'route_parameters' => ['node_type' => 'badge_request'],
        'route_options' => [
          'query' => [
            'edit' => [
              'field_member_to_badge' => [
                'widget' => [
                  0 => ['target_id' => $account->id()],
                ],
              ],
            ],
          ],
        ],
        'category' => t('Member Support'),
        'weight' => 20,
        'description' => t('Manually assign a badge to this user.'),
      ];
    }
    return $links;
  }

  // 3. Admin Audience (Deep management).
  if ($audience === 'admin') {
    // Masquerade Link.
    if ($viewer->hasPermission('masquerade as any user') && $account->id() != $viewer->id()) {
      if (\Drupal::moduleHandler()->moduleExists('masquerade')) {
        $links[] = [
          'id' => 'masquerade',
          'title' => t('Masquerade'),
          'route_name' => 'entity.user.masquerade',
          'route_parameters' => $route_parameters,
          'category' => t('Admin Actions'),
          'weight' => 10,
          'description' => t('Switch to this user session.'),
        ];
      }
    }

    // CiviCRM Contact Link.
    if ($viewer->hasPermission('access CiviCRM') && \Drupal::moduleHandler()->moduleExists('civicrm')) {
      try {
        /** @var \Drupal\civicrm\Civicrm $civicrm_service */
        $civicrm_service = \Drupal::service('civicrm');
        if ($civicrm_service) {
          $civicrm_service->initialize();
          if (function_exists('civicrm_api3')) {
            $result = civicrm_api3('UFMatch', 'get', [
              'uf_id' => $account->id(),
              'sequential' => 1,
            ]);

            if (!empty($result['values'][0]['contact_id'])) {
              $contact_id = $result['values'][0]['contact_id'];
              $links[] = [
                'id' => 'civicrm_contact',
                'title' => t('View CiviCRM Contact'),
                'uri' => 'internal:/civicrm/contact/view',
                'url_options' => [
                  'query' => [
                    'reset' => 1,
                    'cid' => $contact_id,
                  ],
                ],
                'category' => t('CiviCRM'),
                'weight' => 0,
                'description' => t('Open CiviCRM profile.'),
              ];
            }
          }
        }
      }
      catch (\Exception $e) {
        \Drupal::logger('makerspace_user_links')->error('CiviCRM error: @msg', ['@msg' => $e->getMessage()]);
      }
    }
  }

  return $links;
}

/**
 * Route helper to fetch the user from the current route.
 *
 * @deprecated
 *   Most callers should inject the route-match service instead.
 */
function makerspace_user_links_route_user(RouteMatchInterface $route_match): ?UserInterface {
  $route_user = $route_match->getParameter('user');
  if ($route_user instanceof UserInterface) {
    return $route_user;
  }
  if (is_numeric($route_user)) {
    return \Drupal::entityTypeManager()->getStorage('user')->load((int) $route_user);
  }
  return NULL;
}